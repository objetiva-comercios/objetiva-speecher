---
phase: 04-linux-desktop-agent
plan: 04
type: execute
wave: 4
depends_on: ["04-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Linux agent connects to backend and appears in /devices"
    - "Text sent from mobile appears at cursor on Linux desktop"
    - "Agent reconnects after network interruption"
    - "Missing xdotool produces clear error message"
  artifacts: []
  key_links: []
---

<objective>
Verify the Linux agent works end-to-end on a real Linux machine with X11 desktop.

Purpose: Confirm the complete voice-to-cursor flow works on Linux, matching the Windows agent experience.

Output: Verified working Linux agent or documented issues to fix.
</objective>

<execution_context>
@C:\Users\luish\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luish\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-linux-desktop-agent/04-CONTEXT.md
@linux-agent/package.json
@linux-agent/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document Linux setup instructions</name>
  <files>
    linux-agent/README.md
  </files>
  <action>
Create README.md with setup and usage instructions:

1. Create linux-agent/README.md:

```markdown
# Speecher Linux Agent

Receives transcriptions from backend and auto-pastes at cursor position on X11 desktops.

## Prerequisites

1. **X11 Desktop** - Wayland is not supported
2. **xdotool** - For keyboard simulation
3. **Node.js 18+** - Runtime environment

### Installing xdotool

Ubuntu/Debian:
```bash
sudo apt-get install xdotool
```

Fedora:
```bash
sudo dnf install xdotool
```

Arch Linux:
```bash
sudo pacman -S xdotool
```

## Installation

```bash
cd linux-agent
npm install
npm run build
```

## Usage

```bash
# Default: connects to wss://speecher.objetiva.com.ar/ws
npm start

# Or with custom server URL:
SPEECHER_SERVER_URL=ws://192.168.1.100:3000/ws npm start
```

## Development

```bash
npm run dev  # Watch mode with hot reload
```

## Troubleshooting

**"DISPLAY environment variable not set"**
- You're running in a headless environment without X11
- Run this on a desktop with a graphical session

**"xdotool not found"**
- Install xdotool using your package manager (see above)

**"Cannot open display"**
- DISPLAY is set but X11 connection failed
- Ensure you're running in a graphical session, not SSH without X forwarding
```
  </action>
  <verify>
    README.md exists with installation and usage instructions
  </verify>
  <done>
    Documentation exists for Linux agent setup
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Linux desktop agent that:
- Connects to backend WebSocket
- Receives transcription messages
- Pastes text at cursor using xdotool
- Reconnects on network issues
- Validates X11/xdotool at startup
  </what-built>
  <how-to-verify>
**On a Linux machine with X11 desktop:**

1. Install prerequisites:
   ```bash
   # Debian/Ubuntu
   sudo apt-get install xdotool

   # Verify X11
   echo $DISPLAY  # Should show :0 or similar
   ```

2. Build and run the agent:
   ```bash
   cd linux-agent
   npm install
   npm run build
   SPEECHER_SERVER_URL=ws://YOUR_BACKEND:3000/ws npm start
   ```

3. Expected output:
   ```
   {"level":30,"name":"speecher-agent","msg":"Starting Speecher Linux Agent",...}
   {"level":30,"name":"speecher-agent","msg":"Dependencies validated: DISPLAY set, xdotool available"}
   {"level":30,"name":"agent-connection","msg":"Connecting to backend",...}
   {"level":30,"name":"agent-connection","msg":"Registered with backend",...}
   ```

4. Verify agent appears in backend:
   - GET http://YOUR_BACKEND:3000/devices
   - Should list the Linux machine's hostname

5. Test paste flow:
   - Open a text editor on the Linux machine
   - Place cursor in the editor
   - Send transcription from mobile app
   - Text should appear at cursor position

6. Test reconnection:
   - Stop the backend server
   - Agent should log reconnection attempts
   - Restart backend
   - Agent should reconnect automatically

7. Test error handling (optional):
   - Temporarily rename xdotool: sudo mv /usr/bin/xdotool /usr/bin/xdotool.bak
   - Start agent - should fail with clear error
   - Restore: sudo mv /usr/bin/xdotool.bak /usr/bin/xdotool
  </how-to-verify>
  <resume-signal>
Type "approved" if E2E paste works on Linux desktop.
Type "issues: [description]" if problems found.
  </resume-signal>
</task>

</tasks>

<verification>
Human verification covers E2E testing on real Linux hardware.
</verification>

<success_criteria>
- Linux agent starts without errors on X11 desktop
- Agent appears in /devices list
- Text pastes at cursor when transcription received
- Reconnection works after network interruption
- Phase 4 requirements LIN-01 through LIN-07 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-linux-desktop-agent/04-04-SUMMARY.md`
</output>
