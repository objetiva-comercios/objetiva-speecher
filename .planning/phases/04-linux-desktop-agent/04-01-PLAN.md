---
phase: 04-linux-desktop-agent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - linux-agent/package.json
  - linux-agent/tsconfig.json
  - linux-agent/src/types.ts
  - linux-agent/src/config.ts
  - linux-agent/src/startup.ts
autonomous: true

must_haves:
  truths:
    - "Linux agent package can be installed with npm install"
    - "TypeScript compilation succeeds without errors"
    - "Startup validation detects missing DISPLAY variable"
    - "Startup validation detects missing xdotool"
  artifacts:
    - path: "linux-agent/package.json"
      provides: "Package manifest with dependencies"
      contains: "ws"
    - path: "linux-agent/tsconfig.json"
      provides: "TypeScript configuration"
      contains: "ES2022"
    - path: "linux-agent/src/types.ts"
      provides: "Type definitions for agent"
      contains: "ServerMessage"
    - path: "linux-agent/src/config.ts"
      provides: "Configuration constants"
      contains: "SPEECHER_SERVER_URL"
    - path: "linux-agent/src/startup.ts"
      provides: "Dependency validation"
      exports: ["validateDependencies"]
  key_links:
    - from: "linux-agent/src/config.ts"
      to: "process.env.SPEECHER_SERVER_URL"
      via: "environment variable"
      pattern: "process\\.env\\.SPEECHER_SERVER_URL"
---

<objective>
Create the linux-agent package scaffolding with TypeScript configuration, type definitions, configuration constants, and startup dependency validation.

Purpose: Establish the foundation for the Linux desktop agent that mirrors the Windows agent architecture while using X11-compatible tools (xdotool, clipboardy).

Output: A compilable linux-agent/ package with types, config, and startup validation that detects missing X11/xdotool requirements.
</objective>

<execution_context>
@C:\Users\luish\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luish\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-linux-desktop-agent/04-CONTEXT.md
@.planning/phases/04-linux-desktop-agent/04-RESEARCH.md
@windows-agent/package.json
@windows-agent/tsconfig.json
@windows-agent/src/types.ts
@windows-agent/src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create package scaffolding</name>
  <files>
    linux-agent/package.json
    linux-agent/tsconfig.json
  </files>
  <action>
Create linux-agent/ directory and package scaffolding:

1. Create package.json mirroring windows-agent structure:
   - name: "speecher-linux-agent"
   - type: "module" (ESM)
   - main: "dist/index.js"
   - scripts: dev (tsx --watch), build (tsc), start (node dist/index.js)
   - dependencies: ws@^8.0.0, clipboardy@^5.2.1, pino@^9.0.0, command-exists@^1.2.9
   - devDependencies: @types/node@^22.0.0, @types/ws@^8.0.0, pino-pretty@^13.0.0, tsx@^4.0.0, typescript@^5.0.0
   - engines: node >=18

2. Create tsconfig.json identical to windows-agent:
   - target: ES2022
   - module: NodeNext
   - moduleResolution: NodeNext
   - outDir: dist
   - rootDir: src
   - strict: true
   - esModuleInterop: true

Note: No robotjs dependency - Linux uses xdotool via child_process.spawn instead.
  </action>
  <verify>
    npm install runs successfully in linux-agent/
    npm run build produces dist/ directory with no errors
  </verify>
  <done>
    linux-agent/ has valid package.json and tsconfig.json, npm install works, TypeScript compiles empty project
  </done>
</task>

<task type="auto">
  <name>Task 2: Create types and configuration</name>
  <files>
    linux-agent/src/types.ts
    linux-agent/src/config.ts
  </files>
  <action>
Create type definitions and configuration (duplicated from windows-agent per research recommendation):

1. Create src/types.ts - exact copy from windows-agent:
   - ServerMessage type (transcription messages from backend)
   - AgentMessage type (register, ack messages to backend)
   - PasteResult interface (success/method/error)
   - ConnectionState type (disconnected/connecting/connected/registered)

2. Create src/config.ts - same as windows-agent with one naming change:
   - BACKEND_URL from process.env.SPEECHER_SERVER_URL || default wss://speecher.objetiva.com.ar/ws
   - RECONNECT_MIN_DELAY: 1000 (1s)
   - RECONNECT_MAX_DELAY: 30000 (30s)
   - RECONNECT_FACTOR: 2
   - RECONNECT_JITTER: 0.15
   - HEARTBEAT_TIMEOUT: 35000
   - PASTE_DELAY_MS: 75
   - CLIPBOARD_VERIFY_RETRIES: 1

Environment variable is SPEECHER_SERVER_URL (same as Windows, per user decision).
  </action>
  <verify>
    tsc compiles without errors
    types.ts exports ServerMessage, AgentMessage, PasteResult, ConnectionState
    config.ts exports config object with all constants
  </verify>
  <done>
    Types and config match Windows agent exactly, TypeScript compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 3: Create startup dependency validation</name>
  <files>
    linux-agent/src/startup.ts
  </files>
  <action>
Create startup validation module that checks X11 and xdotool availability (fail-fast per research recommendation):

1. Create src/startup.ts with validateDependencies() async function:

   a. Check DISPLAY environment variable:
      - if (!process.env.DISPLAY) throw Error('DISPLAY environment variable not set. X11 required.')

   b. Check xdotool is installed using command-exists package:
      - import commandExists from 'command-exists'
      - try { await commandExists('xdotool') } catch { throw Error with install instructions }
      - Error message: 'xdotool not found. Install: sudo apt-get install xdotool (Debian/Ubuntu) or sudo dnf install xdotool (Fedora)'

   c. Optionally verify X11 clipboard works:
      - Import clipboardy, attempt a read
      - If fails, throw clear error about X11 connection

2. Export validateDependencies as async function that throws on failure.

The entry point (index.ts in next plan) will call this before connecting.
  </action>
  <verify>
    tsc compiles without errors
    startup.ts exports validateDependencies function
    Running on non-X11 system (Windows) would throw DISPLAY error
  </verify>
  <done>
    Startup validation function exists, checks DISPLAY and xdotool, throws clear errors on missing dependencies
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. cd linux-agent && npm install - should succeed
2. npm run build - should produce dist/ with types.js, config.js, startup.js
3. Review generated JS files for correct ESM structure
</verification>

<success_criteria>
- linux-agent/ directory exists with package.json, tsconfig.json
- src/types.ts, src/config.ts, src/startup.ts exist
- npm install succeeds
- npm run build succeeds with no TypeScript errors
- validateDependencies function is exported and callable
</success_criteria>

<output>
After completion, create `.planning/phases/04-linux-desktop-agent/04-01-SUMMARY.md`
</output>
