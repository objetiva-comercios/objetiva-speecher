---
phase: 04-linux-desktop-agent
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - linux-agent/src/paste/clipboard.ts
  - linux-agent/src/paste/keyboard.ts
  - linux-agent/src/paste/paste.ts
autonomous: true

must_haves:
  truths:
    - "Text can be written to X11 clipboard"
    - "Clipboard content can be verified after write"
    - "Ctrl+V keystroke can be simulated via xdotool"
    - "Full paste flow saves original clipboard, pastes, restores"
  artifacts:
    - path: "linux-agent/src/paste/clipboard.ts"
      provides: "Clipboard read/write with verification"
      exports: ["writeClipboard", "readClipboard"]
    - path: "linux-agent/src/paste/keyboard.ts"
      provides: "Keyboard simulation via xdotool"
      exports: ["simulatePaste"]
    - path: "linux-agent/src/paste/paste.ts"
      provides: "Orchestrated paste flow"
      exports: ["pasteText"]
  key_links:
    - from: "linux-agent/src/paste/keyboard.ts"
      to: "xdotool"
      via: "child_process.spawn"
      pattern: "spawn\\('xdotool'"
    - from: "linux-agent/src/paste/paste.ts"
      to: "linux-agent/src/paste/clipboard.ts"
      via: "import"
      pattern: "from './clipboard"
    - from: "linux-agent/src/paste/paste.ts"
      to: "linux-agent/src/paste/keyboard.ts"
      via: "import"
      pattern: "from './keyboard"
---

<objective>
Implement the paste flow for Linux using clipboardy for clipboard operations and xdotool (via child_process.spawn) for keyboard simulation.

Purpose: Enable the Linux agent to receive text and paste it at the cursor position, matching Windows agent functionality but using X11-compatible tools.

Output: Complete paste/ module with clipboard.ts, keyboard.ts, and paste.ts that can write to clipboard and simulate Ctrl+V on X11.
</objective>

<execution_context>
@C:\Users\luish\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luish\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-linux-desktop-agent/04-CONTEXT.md
@.planning/phases/04-linux-desktop-agent/04-RESEARCH.md
@windows-agent/src/paste/clipboard.ts
@windows-agent/src/paste/keyboard.ts
@windows-agent/src/paste/paste.ts
@linux-agent/src/types.ts
@linux-agent/src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create clipboard module</name>
  <files>
    linux-agent/src/paste/clipboard.ts
  </files>
  <action>
Create clipboard module identical to windows-agent (clipboardy works cross-platform):

1. Create src/paste/clipboard.ts:

```typescript
import clipboard from 'clipboardy';
import { config } from '../config.js';

/**
 * Write text to clipboard with verification (LIN-04)
 * Retries once if verification fails
 * @returns true if verified, false if clipboard-only fallback needed
 */
export async function writeClipboard(text: string): Promise<boolean> {
  for (let attempt = 0; attempt <= config.CLIPBOARD_VERIFY_RETRIES; attempt++) {
    await clipboard.write(text);

    // Verify clipboard content
    const content = await clipboard.read();
    if (content === text) {
      return true; // Verified successfully
    }
    // Will retry on next iteration
  }

  // All retries exhausted - text is in clipboard but not verified
  return false;
}

/**
 * Read current clipboard content
 */
export async function readClipboard(): Promise<string> {
  return clipboard.read();
}
```

This is identical to windows-agent because clipboardy abstracts the platform differences. On Linux, it uses xsel (bundled) or xclip internally.
  </action>
  <verify>
    tsc compiles without errors
    clipboard.ts exports writeClipboard and readClipboard
  </verify>
  <done>
    Clipboard module exists with write verification and read functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create keyboard simulation module</name>
  <files>
    linux-agent/src/paste/keyboard.ts
  </files>
  <action>
Create keyboard module using xdotool via child_process.spawn (per user decision - no robotjs):

1. Create src/paste/keyboard.ts:

```typescript
import { spawn } from 'child_process';

/**
 * Simulate Ctrl+V keystroke using xdotool (LIN-05, LIN-07)
 * Uses xdotool key command which synthesizes X11 key events
 * --clearmodifiers ensures no residual modifier state
 * @throws Error if xdotool fails
 */
export function simulatePaste(): Promise<void> {
  return new Promise((resolve, reject) => {
    // Use 'key' command with ctrl+v combination
    // --clearmodifiers clears any stuck modifier keys first
    const xdotool = spawn('xdotool', ['key', '--clearmodifiers', 'ctrl+v']);

    let stderr = '';
    xdotool.stderr.on('data', (data) => {
      stderr += data.toString();
    });

    xdotool.on('close', (code) => {
      if (code === 0) {
        resolve();
      } else {
        reject(new Error(`xdotool failed (code ${code}): ${stderr}`));
      }
    });

    xdotool.on('error', (err) => {
      reject(new Error(`Failed to spawn xdotool: ${err.message}`));
    });
  });
}
```

Key differences from Windows:
- Returns Promise (async) instead of synchronous robotjs call
- Uses child_process.spawn to invoke xdotool
- --clearmodifiers prevents stuck modifier key issues
- xdotool uses X11 XTEST extension for reliable key injection
  </action>
  <verify>
    tsc compiles without errors
    keyboard.ts exports simulatePaste as async function
  </verify>
  <done>
    Keyboard module exists, uses xdotool spawn for Ctrl+V simulation
  </done>
</task>

<task type="auto">
  <name>Task 3: Create paste orchestration module</name>
  <files>
    linux-agent/src/paste/paste.ts
  </files>
  <action>
Create paste orchestration identical to Windows but with async keyboard call:

1. Create src/paste/paste.ts:

```typescript
import { writeClipboard, readClipboard } from './clipboard.js';
import { simulatePaste } from './keyboard.js';
import { config } from '../config.js';
import type { PasteResult } from '../types.js';
import clipboard from 'clipboardy';

/**
 * Delay helper
 */
function delay(ms: number): Promise<void> {
  return new Promise(resolve => setTimeout(resolve, ms));
}

/**
 * Full paste flow: save clipboard -> write -> verify -> delay -> Ctrl+V -> restore
 * Preserves user's original clipboard content after pasting
 * Falls back to clipboard-only if paste simulation fails
 *
 * @param text - Text to paste
 * @returns PasteResult with success status and method used
 */
export async function pasteText(text: string): Promise<PasteResult> {
  // Step 0: Save original clipboard content
  let originalClipboard: string | null = null;
  try {
    originalClipboard = await readClipboard();
  } catch {
    // Clipboard might be empty or contain non-text data - that's ok
    originalClipboard = null;
  }

  // Step 1: Write to clipboard with verification (LIN-04)
  const verified = await writeClipboard(text);

  if (!verified) {
    // Clipboard write or verification failed
    await restoreClipboard(originalClipboard);
    return {
      success: false,
      method: 'clipboard-only',
      error: 'Clipboard verification failed after retries',
    };
  }

  // Step 2: Delay before paste
  await delay(config.PASTE_DELAY_MS);

  // Step 3: Simulate Ctrl+V (LIN-05)
  try {
    await simulatePaste(); // Note: async on Linux, unlike Windows

    // Step 4: Small delay to ensure paste completes before restoring clipboard
    await delay(100);

    // Step 5: Restore original clipboard content
    await restoreClipboard(originalClipboard);

    return {
      success: true,
      method: 'paste',
    };
  } catch (error) {
    // Paste simulation failed, try to restore clipboard
    await restoreClipboard(originalClipboard);
    return {
      success: false,
      method: 'clipboard-only',
      error: error instanceof Error ? error.message : 'Paste simulation failed',
    };
  }
}

/**
 * Restore clipboard to original content
 */
async function restoreClipboard(content: string | null): Promise<void> {
  if (content !== null) {
    try {
      await clipboard.write(content);
    } catch {
      // Failed to restore - not critical
    }
  }
}
```

Key difference from Windows: simulatePaste() is awaited because it's async (child_process spawn).
  </action>
  <verify>
    tsc compiles without errors
    paste.ts exports pasteText function
    npm run build succeeds for entire linux-agent
  </verify>
  <done>
    Paste orchestration module exists with full flow: save -> write -> verify -> paste -> restore
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. cd linux-agent && npm run build - should succeed
2. Verify paste/ directory has clipboard.ts, keyboard.ts, paste.ts
3. Verify dist/paste/ has corresponding .js files after build
</verification>

<success_criteria>
- linux-agent/src/paste/ directory exists with all three files
- TypeScript compiles without errors
- pasteText function accepts text and returns Promise<PasteResult>
- simulatePaste spawns xdotool with correct arguments
- writeClipboard verifies content after writing
</success_criteria>

<output>
After completion, create `.planning/phases/04-linux-desktop-agent/04-02-SUMMARY.md`
</output>
