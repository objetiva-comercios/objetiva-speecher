---
phase: 05-command-parser-text-symbols
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - mobile-app/src/hooks/useSpeechRecognition.ts
  - mobile-app/src/components/TranscriptionEditor.tsx
autonomous: true

must_haves:
  truths:
    - "User speaks 'punto' and sees '.' appear in real-time"
    - "User speaks 'hola coma adios' and sees 'hola, adios' in the transcription"
    - "Commands convert visually with brief highlight feedback"
    - "Edited text in editing mode is NOT re-parsed (only speech input)"
  artifacts:
    - path: "mobile-app/src/hooks/useSpeechRecognition.ts"
      provides: "Parser integration in speech callback"
      contains: "parseCommands"
    - path: "mobile-app/src/components/TranscriptionEditor.tsx"
      provides: "Visual feedback for converted symbols"
      contains: "animate"
  key_links:
    - from: "useSpeechRecognition.ts"
      to: "commandParser.ts"
      via: "import parseCommands"
      pattern: "import.*parseCommands.*from.*commandParser"
    - from: "useSpeechRecognition.ts onPartialResults"
      to: "parseCommands"
      via: "function call on speech text"
      pattern: "parseCommands\\(text\\)"
---

<objective>
Integrate the command parser into the speech recognition flow and add visual feedback.

Purpose: Make the parser live - when users speak commands, they see symbols appear in real-time. Visual feedback (brief highlight) confirms conversions happened.

Output: Updated useSpeechRecognition hook with parser integration and TranscriptionEditor with highlight animation.
</objective>

<execution_context>
@C:\Users\luish\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luish\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-command-parser-text-symbols/05-CONTEXT.md
@.planning/phases/05-command-parser-text-symbols/05-01-SUMMARY.md
@mobile-app/src/hooks/useSpeechRecognition.ts
@mobile-app/src/components/TranscriptionEditor.tsx
@mobile-app/src/services/commandParser.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate parser into speech recognition hook</name>
  <files>mobile-app/src/hooks/useSpeechRecognition.ts</files>
  <action>
    Integrate parseCommands into the useSpeechRecognition hook:

    1. Import parseCommands from '../services/commandParser'

    2. In the onPartialResults callback (line ~125-131), apply parser to incoming text:
       ```typescript
       // onPartialResults - live text updates
       (text) => {
         console.log('[Speech] Partial result:', text);
         const parsed = parseCommands(text);
         liveTextRef.current = parsed;
         setLiveText(parsed);
         // Reset silence timer - user is speaking
         resetSilenceTimer();
       },
       ```

    3. Do NOT parse in finalizeRecording - liveTextRef already contains parsed text

    4. Do NOT parse when user edits text manually - only speech input gets parsed

    Per CONTEXT.md: Parse in real-time as user speaks. Claude's discretion on whether interim or final results - we parse interim (onPartialResults) for immediate feedback.
  </action>
  <verify>
    Build succeeds: `cd mobile-app && npm run build`
    TypeScript compiles with no errors.
  </verify>
  <done>
    - useSpeechRecognition imports and uses parseCommands
    - Parser is applied in onPartialResults callback
    - liveText state contains parsed text
    - Manual text editing in 'editing' state is NOT parsed
  </done>
</task>

<task type="auto">
  <name>Task 2: Add visual feedback for command conversions</name>
  <files>mobile-app/src/components/TranscriptionEditor.tsx</files>
  <action>
    Add visual feedback when commands convert to symbols (per CONTEXT.md: brief highlight/pulse, visual only):

    1. Track when text contains recently-converted symbols by comparing current vs previous liveText.

    2. Add a subtle pulse animation to the recording mode display:
       - When liveText changes and differs from previous by a symbol replacement, briefly highlight
       - Use Tailwind's animate-pulse or a custom quick flash

    3. Implementation approach (Claude's discretion on exact timing):
       ```typescript
       // In recording mode render:
       const [showPulse, setShowPulse] = useState(false);
       const prevLiveTextRef = useRef('');

       useEffect(() => {
         if (isRecording && liveText !== prevLiveTextRef.current) {
           // Check if text got shorter (command word replaced with symbol)
           // or contains new punctuation
           const hadConversion = liveText.length < prevLiveTextRef.current.length ||
             /[.,;:!?@#$%(){}\[\]"'-]/.test(liveText.slice(-3));

           if (hadConversion) {
             setShowPulse(true);
             setTimeout(() => setShowPulse(false), 200);
           }
           prevLiveTextRef.current = liveText;
         }
       }, [liveText, isRecording]);
       ```

    4. Add pulse style to the text display:
       ```tsx
       <p className={`text-gray-700 transition-colors ${showPulse ? 'text-blue-600' : ''}`}>
       ```

    5. Alternative: Use a brief background flash instead of text color change.
       Per CONTEXT.md: "Claude's discretion on highlight animation duration and style"
       Recommended: 150-200ms, subtle color change (blue-600 text or blue-50 background).

    Do NOT add audio feedback (per CONTEXT.md: "No audio feedback").
  </action>
  <verify>
    Build succeeds: `cd mobile-app && npm run build`
    Visual inspection: Component renders without errors.
  </verify>
  <done>
    - TranscriptionEditor shows brief visual feedback when commands convert
    - Animation is subtle (150-200ms) and non-disruptive
    - No audio feedback
    - Works in recording mode only (not editing mode)
  </done>
</task>

</tasks>

<verification>
```bash
# Build check
cd mobile-app && npm run build

# Run existing tests to ensure no regressions
cd mobile-app && npm test -- --run
```

Manual testing will be done in Plan 03 (checkpoint).
</verification>

<success_criteria>
- useSpeechRecognition hook applies parseCommands to speech results
- liveText contains parsed text with symbols instead of command words
- TranscriptionEditor shows visual feedback on conversions
- Build passes, no TypeScript errors
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-command-parser-text-symbols/05-02-SUMMARY.md`
</output>
