---
phase: 06-key-actions-protocol
plan: 05
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - linux-agent/src/paste/keyboard.ts
  - linux-agent/src/agent/connection.ts
autonomous: true

must_haves:
  truths:
    - "Linux agent executes Enter key (Return) when receiving key:enter segment"
    - "Linux agent executes Tab key when receiving key:tab segment"
    - "Agent processes segments sequentially with delay between each"
    - "Text segments are pasted, key segments trigger key presses via xdotool"
  artifacts:
    - path: "linux-agent/src/paste/keyboard.ts"
      provides: "executeKeyAction function using xdotool"
      exports: ["executeKeyAction"]
    - path: "linux-agent/src/agent/connection.ts"
      provides: "Segment processing in onMessage handler"
      contains: "processPayload"
  key_links:
    - from: "linux-agent/src/agent/connection.ts"
      to: "linux-agent/src/paste/keyboard.ts"
      via: "executeKeyAction called for key segments"
      pattern: "executeKeyAction.*segment\\.key"
    - from: "linux-agent/src/agent/connection.ts"
      to: "linux-agent/src/paste/paste.ts"
      via: "pasteText called for text segments"
      pattern: "pasteText.*segment\\.value"
---

<objective>
Implement key action execution in the Linux agent using xdotool.

Purpose: Implements AGENT-02 - Linux agent executes Enter and Tab key actions received from backend. This completes the end-to-end flow for key commands on Linux X11 desktops.

Output: executeKeyAction function in keyboard.ts using xdotool, updated connection.ts with segment processing.
</objective>

<execution_context>
@C:\Users\luish\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luish\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-key-actions-protocol/06-RESEARCH.md
@.planning/phases/06-key-actions-protocol/06-01-SUMMARY.md

# Source files
@linux-agent/src/paste/keyboard.ts
@linux-agent/src/paste/paste.ts
@linux-agent/src/agent/connection.ts
@linux-agent/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add executeKeyAction function to keyboard.ts</name>
  <files>linux-agent/src/paste/keyboard.ts</files>
  <action>
Add a new function to execute Enter/Tab key presses using xdotool:

```typescript
import { spawn } from 'child_process';
import type { KeyAction } from '../types.js';

/**
 * Mapping from abstract KeyAction to xdotool X11 keysym names.
 * xdotool uses X11 keysym names: Return (not Enter), Tab.
 */
const XDOTOOL_KEYS: Record<KeyAction, string> = {
  enter: 'Return',  // X11 keysym for Enter key
  tab: 'Tab',
};

/**
 * Simulate Ctrl+V keystroke using xdotool (LIN-05, LIN-07)
 * Uses xdotool key command which synthesizes X11 key events
 * --clearmodifiers ensures no residual modifier state
 * @throws Error if xdotool fails
 */
export function simulatePaste(): Promise<void> {
  return new Promise((resolve, reject) => {
    const xdotool = spawn('xdotool', ['key', '--clearmodifiers', 'ctrl+v']);

    let stderr = '';
    xdotool.stderr.on('data', (data) => {
      stderr += data.toString();
    });

    xdotool.on('close', (code) => {
      if (code === 0) {
        resolve();
      } else {
        reject(new Error(`xdotool failed (code ${code}): ${stderr}`));
      }
    });

    xdotool.on('error', (err) => {
      reject(new Error(`Failed to spawn xdotool: ${err.message}`));
    });
  });
}

/**
 * Execute a key action (Enter or Tab) using xdotool.
 * Uses xdotool key command with --clearmodifiers for reliable execution.
 * @param key - The key action to execute ('enter' or 'tab')
 * @returns Promise that resolves when key press completes
 */
export function executeKeyAction(key: KeyAction): Promise<void> {
  return new Promise((resolve, reject) => {
    const xdotoolKey = XDOTOOL_KEYS[key];

    const xdotool = spawn('xdotool', ['key', '--clearmodifiers', xdotoolKey]);

    let stderr = '';
    xdotool.stderr.on('data', (data) => {
      stderr += data.toString();
    });

    xdotool.on('close', (code) => {
      if (code === 0) {
        resolve();
      } else {
        reject(new Error(`xdotool key ${xdotoolKey} failed (code ${code}): ${stderr}`));
      }
    });

    xdotool.on('error', (err) => {
      reject(new Error(`Failed to spawn xdotool: ${err.message}`));
    });
  });
}
```

Important: xdotool uses X11 keysym names, NOT the same names as robotjs:
- 'enter' -> 'Return' (X11 keysym)
- 'tab' -> 'Tab' (X11 keysym)

The XDOTOOL_KEYS mapping handles this translation.
  </action>
  <verify>
```bash
cd linux-agent && npx tsc --noEmit
```
  </verify>
  <done>
- executeKeyAction function exported from keyboard.ts
- Uses xdotool with X11 keysym names (Return, Tab)
- KeyAction type imported from types.ts
- --clearmodifiers flag used for reliable execution
- Returns Promise (async operation)
- TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Update connection.ts to process segments</name>
  <files>linux-agent/src/agent/connection.ts</files>
  <action>
Update the onMessage handler to process Segment arrays (same pattern as Windows agent):

1. Import new types and functions:
```typescript
import { executeKeyAction } from '../paste/keyboard.js';
import type { ServerMessage, AgentMessage, ConnectionState, Segment } from '../types.js';
```

2. Add delay helper if not present:
```typescript
const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

// Delay between segments for reliable execution (research: 50ms)
const SEGMENT_DELAY_MS = 50;
```

3. Add processPayload function:
```typescript
/**
 * Process a payload of segments sequentially.
 * Text segments are pasted, key segments execute key presses.
 */
async function processPayload(payload: Segment[]): Promise<void> {
  for (let i = 0; i < payload.length; i++) {
    const segment = payload[i];

    switch (segment.type) {
      case 'text':
        if (segment.value) {
          await pasteText(segment.value);
        }
        break;
      case 'key':
        await executeKeyAction(segment.key);  // Note: async for xdotool
        break;
    }

    // Delay between segments (not after last one)
    if (i < payload.length - 1) {
      await delay(SEGMENT_DELAY_MS);
    }
  }
}
```

4. Update onMessage handler:
```typescript
private async onMessage(data: WebSocket.RawData): Promise<void> {
  try {
    const msg = JSON.parse(data.toString()) as ServerMessage;

    if (msg.type === 'transcription') {
      // Handle both new payload format and legacy text format
      if (msg.payload && msg.payload.length > 0) {
        logger.info({ id: msg.id, segments: msg.payload.length }, 'Received transcription with segments');
        await processPayload(msg.payload);
      } else if (msg.text) {
        // Legacy: text-only message (backwards compatibility)
        logger.info({ id: msg.id, textLength: msg.text.length }, 'Received legacy text transcription');
        await pasteText(msg.text);
      }

      // Log result
      logger.info({ id: msg.id }, 'Transcription processed');

      // Send ACK after processing
      const ack: AgentMessage = { type: 'ack', id: msg.id };
      this.ws?.send(JSON.stringify(ack));
      logger.debug({ id: msg.id }, 'ACK sent');
    }
  } catch (err) {
    logger.error({ err, data: data.toString() }, 'Failed to process message');
  }
}
```

Note: The main difference from Windows agent is that executeKeyAction is async (returns Promise) because xdotool is spawned as a child process.
  </action>
  <verify>
```bash
cd linux-agent && npx tsc --noEmit
cd linux-agent && npm run build
```
  </verify>
  <done>
- processPayload function handles Segment array
- Text segments call pasteText
- Key segments call executeKeyAction (awaited)
- 50ms delay between segments
- Backwards compatible with text-only messages
- TypeScript compiles and builds
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Manual test on Linux (requires running backend + agent + X11):
   - Send message with payload: `[{"type":"text","value":"hello"},{"type":"key","key":"enter"},{"type":"text","value":"world"}]`
   - Expect: "hello" pasted, Enter key pressed (cursor to new line), "world" pasted
</verification>

<success_criteria>
- executeKeyAction function works with 'enter' -> Return and 'tab' -> Tab
- Agent processes payload segments in order
- 50ms delay between segments for reliable execution
- Text segments pasted via xclip, key segments executed via xdotool
- Backwards compatible with legacy text-only messages
- TypeScript compiles, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-key-actions-protocol/06-05-SUMMARY.md`
</output>
