---
phase: 06-key-actions-protocol
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - windows-agent/src/paste/keyboard.ts
  - windows-agent/src/agent/connection.ts
autonomous: true

must_haves:
  truths:
    - "Windows agent executes Enter key when receiving key:enter segment"
    - "Windows agent executes Tab key when receiving key:tab segment"
    - "Agent processes segments sequentially with delay between each"
    - "Text segments are pasted, key segments trigger key presses"
  artifacts:
    - path: "windows-agent/src/paste/keyboard.ts"
      provides: "executeKeyAction function using robotjs keyTap"
      exports: ["executeKeyAction"]
    - path: "windows-agent/src/agent/connection.ts"
      provides: "Segment processing in onMessage handler"
      contains: "processPayload"
  key_links:
    - from: "windows-agent/src/agent/connection.ts"
      to: "windows-agent/src/paste/keyboard.ts"
      via: "executeKeyAction called for key segments"
      pattern: "executeKeyAction.*segment\\.key"
    - from: "windows-agent/src/agent/connection.ts"
      to: "windows-agent/src/paste/paste.ts"
      via: "pasteText called for text segments"
      pattern: "pasteText.*segment\\.value"
---

<objective>
Implement key action execution in the Windows agent using robotjs.

Purpose: Implements AGENT-01 - Windows agent executes Enter and Tab key actions received from backend. This completes the end-to-end flow for key commands on Windows.

Output: executeKeyAction function in keyboard.ts, updated connection.ts with segment processing.
</objective>

<execution_context>
@C:\Users\luish\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luish\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-key-actions-protocol/06-RESEARCH.md
@.planning/phases/06-key-actions-protocol/06-01-SUMMARY.md

# Source files
@windows-agent/src/paste/keyboard.ts
@windows-agent/src/paste/paste.ts
@windows-agent/src/agent/connection.ts
@windows-agent/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add executeKeyAction function to keyboard.ts</name>
  <files>windows-agent/src/paste/keyboard.ts</files>
  <action>
Add a new function to execute Enter/Tab key presses:

```typescript
import robot from '@jitsi/robotjs';
import type { KeyAction } from '../types.js';

/**
 * Simulate Ctrl+V keystroke (WIN-05)
 * Uses robotjs keyTap which handles press and release atomically
 * @throws Error if keyboard simulation fails
 */
export function simulatePaste(): void {
  robot.keyTap('v', 'control');
}

/**
 * Execute a key action (Enter or Tab)
 * Uses robotjs keyTap for atomic key press/release
 * @param key - The key action to execute ('enter' or 'tab')
 */
export function executeKeyAction(key: KeyAction): void {
  // robotjs uses lowercase key names: 'enter', 'tab'
  // These match our KeyAction type directly
  robot.keyTap(key);
}
```

Note: robotjs keyTap is synchronous but reliable. The key names 'enter' and 'tab' are directly supported by robotjs (verified in research).
  </action>
  <verify>
```bash
cd windows-agent && npx tsc --noEmit
```
  </verify>
  <done>
- executeKeyAction function exported from keyboard.ts
- Uses robotjs keyTap with key parameter directly
- KeyAction type imported from types.ts
- TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Update connection.ts to process segments</name>
  <files>windows-agent/src/agent/connection.ts</files>
  <action>
Update the onMessage handler to process Segment arrays:

1. Import new types and functions:
```typescript
import { executeKeyAction } from '../paste/keyboard.js';
import type { ServerMessage, AgentMessage, ConnectionState, Segment } from '../types.js';
```

2. Add delay helper if not present:
```typescript
const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

// Delay between segments for reliable execution (research: 50ms)
const SEGMENT_DELAY_MS = 50;
```

3. Add processPayload function:
```typescript
/**
 * Process a payload of segments sequentially.
 * Text segments are pasted, key segments execute key presses.
 */
async function processPayload(payload: Segment[]): Promise<void> {
  for (let i = 0; i < payload.length; i++) {
    const segment = payload[i];

    switch (segment.type) {
      case 'text':
        if (segment.value) {
          await pasteText(segment.value);
        }
        break;
      case 'key':
        executeKeyAction(segment.key);
        break;
    }

    // Delay between segments (not after last one)
    if (i < payload.length - 1) {
      await delay(SEGMENT_DELAY_MS);
    }
  }
}
```

4. Update onMessage handler:
```typescript
private async onMessage(data: WebSocket.RawData): Promise<void> {
  try {
    const msg = JSON.parse(data.toString()) as ServerMessage;

    if (msg.type === 'transcription') {
      // Handle both new payload format and legacy text format
      if (msg.payload && msg.payload.length > 0) {
        logger.info({ id: msg.id, segments: msg.payload.length }, 'Received transcription with segments');
        await processPayload(msg.payload);
      } else if (msg.text) {
        // Legacy: text-only message (backwards compatibility)
        logger.info({ id: msg.id, textLength: msg.text.length }, 'Received legacy text transcription');
        await pasteText(msg.text);
      }

      // Log result (processPayload handles individual segment logging internally)
      logger.info({ id: msg.id }, 'Transcription processed');

      // Send ACK after processing
      const ack: AgentMessage = { type: 'ack', id: msg.id };
      this.ws?.send(JSON.stringify(ack));
      logger.debug({ id: msg.id }, 'ACK sent');
    }
  } catch (err) {
    logger.error({ err, data: data.toString() }, 'Failed to process message');
  }
}
```

Note: The existing `pasteText` import and usage is preserved for text segments. The new flow adds key action handling.
  </action>
  <verify>
```bash
cd windows-agent && npx tsc --noEmit
cd windows-agent && npm run build
```
  </verify>
  <done>
- processPayload function handles Segment array
- Text segments call pasteText
- Key segments call executeKeyAction
- 50ms delay between segments
- Backwards compatible with text-only messages
- TypeScript compiles and builds
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Manual test (requires running backend + agent):
   - Send message with payload: `[{"type":"text","value":"hello"},{"type":"key","key":"enter"},{"type":"text","value":"world"}]`
   - Expect: "hello" pasted, Enter key pressed, "world" pasted
</verification>

<success_criteria>
- executeKeyAction function works with 'enter' and 'tab' keys
- Agent processes payload segments in order
- 50ms delay between segments for reliable execution
- Text segments pasted, key segments executed as key presses
- Backwards compatible with legacy text-only messages
- TypeScript compiles, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-key-actions-protocol/06-04-SUMMARY.md`
</output>
