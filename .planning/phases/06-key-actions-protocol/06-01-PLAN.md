---
phase: 06-key-actions-protocol
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mobile-app/src/types/index.ts
  - backend-server/src/types/messages.ts
  - windows-agent/src/types.ts
  - linux-agent/src/types.ts
autonomous: true

must_haves:
  truths:
    - "All packages have consistent Segment and KeyAction type definitions"
    - "Types are discriminated unions for type-safe exhaustive handling"
    - "ServerMessage supports payload field with Segment array"
  artifacts:
    - path: "mobile-app/src/types/index.ts"
      provides: "Segment and KeyAction types for mobile app"
      contains: "type KeyAction"
    - path: "backend-server/src/types/messages.ts"
      provides: "Updated ServerMessage with payload field"
      contains: "payload: Segment[]"
    - path: "windows-agent/src/types.ts"
      provides: "Segment types for Windows agent"
      contains: "type Segment"
    - path: "linux-agent/src/types.ts"
      provides: "Segment types for Linux agent"
      contains: "type Segment"
  key_links:
    - from: "backend-server/src/types/messages.ts"
      to: "windows-agent/src/types.ts"
      via: "Identical Segment type definitions"
      pattern: "type: 'text'.*type: 'key'"
---

<objective>
Add shared type definitions for the key actions protocol across all packages.

Purpose: Establish type-safe foundation for Segment-based message protocol that supports interleaved text and key actions (Enter, Tab). This enables all subsequent plans to work with consistent types.

Output: Updated types files in all 4 packages with KeyAction, Segment, and updated ServerMessage types.
</objective>

<execution_context>
@C:\Users\luish\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luish\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-key-actions-protocol/06-RESEARCH.md

# Existing type files
@mobile-app/src/types/index.ts
@backend-server/src/types/messages.ts
@windows-agent/src/types.ts
@linux-agent/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Segment and KeyAction types to all packages</name>
  <files>
    mobile-app/src/types/index.ts
    backend-server/src/types/messages.ts
    windows-agent/src/types.ts
    linux-agent/src/types.ts
  </files>
  <action>
Add the following type definitions to each package's types file:

```typescript
// Key action types for Enter/Tab simulation
export type KeyAction = 'enter' | 'tab';

// Segment: discriminated union for type-safe payload handling
export type Segment =
  | { type: 'text'; value: string }
  | { type: 'key'; key: KeyAction };
```

For backend-server/src/types/messages.ts, also update ServerMessage:
- Add `payload?: Segment[]` field to the transcription type (optional for backwards compat)
- Keep existing `text` field for now (deprecated, will be removed in v1.2)

Result should be:
```typescript
export type ServerMessage =
  | { type: 'transcription'; id: string; text?: string; payload?: Segment[]; timestamp: number }
```

For QueuedMessage, add `payload?: Segment[]` field alongside `text`.

Place the new types near the top of each file, after imports but before existing types.
  </action>
  <verify>
Run TypeScript compilation in each package to verify no type errors:
```bash
cd mobile-app && npx tsc --noEmit
cd backend-server && npx tsc --noEmit
cd windows-agent && npx tsc --noEmit
cd linux-agent && npx tsc --noEmit
```
All must pass with no errors.
  </verify>
  <done>
- KeyAction type exported from all 4 packages
- Segment discriminated union exported from all 4 packages
- ServerMessage in backend-server has payload field
- QueuedMessage in backend-server has payload field
- TypeScript compiles successfully in all packages
  </done>
</task>

</tasks>

<verification>
1. `grep -r "type KeyAction" mobile-app/src backend-server/src windows-agent/src linux-agent/src` shows 4 matches
2. `grep -r "type Segment" mobile-app/src backend-server/src windows-agent/src linux-agent/src` shows 4 matches
3. TypeScript compilation passes in all packages
</verification>

<success_criteria>
- All 4 packages have identical KeyAction and Segment type definitions
- Backend ServerMessage type includes payload?: Segment[] field
- No TypeScript compilation errors in any package
- Types enable discriminated union exhaustive checking (type: 'text' | type: 'key')
</success_criteria>

<output>
After completion, create `.planning/phases/06-key-actions-protocol/06-01-SUMMARY.md`
</output>
