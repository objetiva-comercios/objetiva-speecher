---
phase: 06-key-actions-protocol
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - mobile-app/src/services/commandParser.ts
  - mobile-app/src/services/api.ts
  - mobile-app/src/hooks/useSpeechRecognition.ts
autonomous: true

must_haves:
  truths:
    - "User says 'nueva linea' and parser outputs key segment for Enter"
    - "User says 'tabulador' and parser outputs key segment for Tab"
    - "Mixed text and commands produce correct Segment array"
    - "API sends payload instead of text to backend"
  artifacts:
    - path: "mobile-app/src/services/commandParser.ts"
      provides: "parseToSegments function returning Segment[]"
      exports: ["parseToSegments"]
    - path: "mobile-app/src/services/api.ts"
      provides: "Updated sendTranscription accepting Segment[]"
      contains: "payload"
  key_links:
    - from: "mobile-app/src/services/commandParser.ts"
      to: "mobile-app/src/services/api.ts"
      via: "parseToSegments output used by sendTranscription"
      pattern: "parseToSegments.*Segment"
    - from: "mobile-app/src/hooks/useSpeechRecognition.ts"
      to: "mobile-app/src/services/api.ts"
      via: "Hook calls API with parsed segments"
      pattern: "sendTranscription.*payload"
---

<objective>
Extend the mobile command parser to detect key action commands and produce Segment arrays. Update API client to send payload format.

Purpose: Implements KEY-01 and KEY-02 by parsing "nueva linea", "enter", "tabulador", "tab" voice commands and converting them to typed key action segments that agents can execute.

Output: Extended commandParser.ts with parseToSegments function, updated api.ts with payload-based sendTranscription.
</objective>

<execution_context>
@C:\Users\luish\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luish\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-key-actions-protocol/06-RESEARCH.md
@.planning/phases/06-key-actions-protocol/06-01-SUMMARY.md

# Source files
@mobile-app/src/services/commandParser.ts
@mobile-app/src/services/api.ts
@mobile-app/src/hooks/useSpeechRecognition.ts
@mobile-app/src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add parseToSegments function to commandParser.ts</name>
  <files>mobile-app/src/services/commandParser.ts</files>
  <action>
Add a new `parseToSegments` function that:

1. First applies existing `parseCommands()` for punctuation/symbol replacement
2. Then detects key action commands and splits into Segment array

Key action patterns (case-insensitive):
- Enter: 'nueva linea', 'nueva línea', 'enter'
- Tab: 'tabulador', 'tab'

Implementation approach:
```typescript
import type { Segment, KeyAction } from '../types';

interface KeyCommandDef {
  patterns: string[];
  key: KeyAction;
}

const KEY_COMMANDS: KeyCommandDef[] = [
  { patterns: ['nueva linea', 'nueva línea', 'enter'], key: 'enter' },
  { patterns: ['tabulador', 'tab'], key: 'tab' },
];

export function parseToSegments(text: string): Segment[] {
  // Step 1: Apply text command parsing (punctuation, symbols)
  const parsed = parseCommands(text);

  // Step 2: Split on key commands
  return splitIntoSegments(parsed);
}

function splitIntoSegments(text: string): Segment[] {
  const segments: Segment[] = [];

  // Build combined regex for all key commands (longest first)
  const allPatterns = KEY_COMMANDS
    .flatMap(kc => kc.patterns)
    .sort((a, b) => b.length - a.length);

  const regex = new RegExp(
    `\\b(${allPatterns.map(escapeRegexChars).join('|')})\\b`,
    'gi'
  );

  let lastIndex = 0;
  let match;

  while ((match = regex.exec(text)) !== null) {
    // Add text before match (if non-empty after trim)
    if (match.index > lastIndex) {
      const textBefore = text.slice(lastIndex, match.index).trim();
      if (textBefore) {
        segments.push({ type: 'text', value: textBefore });
      }
    }

    // Add key action
    const matchedPattern = match[1].toLowerCase();
    // Handle accented variants
    const normalizedPattern = matchedPattern
      .replace(/í/g, 'i')
      .replace(/é/g, 'e');

    const keyCmd = KEY_COMMANDS.find(kc =>
      kc.patterns.some(p =>
        p.toLowerCase().replace(/í/g, 'i').replace(/é/g, 'e') === normalizedPattern
      )
    );

    if (keyCmd) {
      segments.push({ type: 'key', key: keyCmd.key });
    }

    lastIndex = regex.lastIndex;
  }

  // Add remaining text
  if (lastIndex < text.length) {
    const textAfter = text.slice(lastIndex).trim();
    if (textAfter) {
      segments.push({ type: 'text', value: textAfter });
    }
  }

  // If no segments, return empty array (not a text segment with empty string)
  return segments;
}
```

Note: The existing `escapeRegexChars` function is already in the file - reuse it.
  </action>
  <verify>
Add unit tests to verify key action parsing:
```bash
cd mobile-app && npm test -- --run
```

Test cases to verify:
- "hola enter mundo" -> [text:"hola", key:"enter", text:"mundo"]
- "nueva linea" -> [key:"enter"]
- "tab hola tabulador" -> [key:"tab", text:"hola", key:"tab"]
- "punto enter" -> [text:".", key:"enter"] (punctuation parsed first)
  </verify>
  <done>
- parseToSegments function exported from commandParser.ts
- Detects "nueva linea", "nueva linea", "enter" for Enter key
- Detects "tabulador", "tab" for Tab key
- Punctuation commands still work (parseCommands applied first)
- Empty input returns empty array
- Mixed content returns correct Segment array
  </done>
</task>

<task type="auto">
  <name>Task 2: Update API client to send payload format</name>
  <files>
    mobile-app/src/services/api.ts
    mobile-app/src/hooks/useSpeechRecognition.ts
  </files>
  <action>
Update api.ts sendTranscription method:

1. Change signature to accept Segment[] instead of string:
```typescript
async sendTranscription(deviceId: string, payload: Segment[]): Promise<ApiResponse>
```

2. Update fetch body to send payload:
```typescript
body: JSON.stringify({ deviceId, payload }),
```

3. Import Segment type from types/index.ts

Update useSpeechRecognition.ts to use parseToSegments:

1. Import parseToSegments from services/commandParser
2. In the send flow (where text is sent to API), use:
```typescript
const segments = parseToSegments(finalText);
await apiClient.sendTranscription(deviceId, segments);
```

Note: The exact location depends on current hook structure. Find where sendTranscription is called with text and replace with segment-based call.
  </action>
  <verify>
1. TypeScript compilation passes: `cd mobile-app && npx tsc --noEmit`
2. Build succeeds: `cd mobile-app && npm run build`
  </verify>
  <done>
- sendTranscription accepts Segment[] parameter named 'payload'
- API sends { deviceId, payload } in request body
- useSpeechRecognition uses parseToSegments before sending
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Add parseToSegments tests</name>
  <files>mobile-app/src/services/commandParser.test.ts</files>
  <action>
Add test suite for parseToSegments function in the existing test file:

```typescript
describe('parseToSegments', () => {
  describe('key action detection', () => {
    it('detects "enter" as key action', () => {
      expect(parseToSegments('enter')).toEqual([
        { type: 'key', key: 'enter' }
      ]);
    });

    it('detects "nueva linea" as key action', () => {
      expect(parseToSegments('nueva linea')).toEqual([
        { type: 'key', key: 'enter' }
      ]);
    });

    it('detects "nueva linea" with accent as key action', () => {
      expect(parseToSegments('nueva linea')).toEqual([
        { type: 'key', key: 'enter' }
      ]);
    });

    it('detects "tab" as key action', () => {
      expect(parseToSegments('tab')).toEqual([
        { type: 'key', key: 'tab' }
      ]);
    });

    it('detects "tabulador" as key action', () => {
      expect(parseToSegments('tabulador')).toEqual([
        { type: 'key', key: 'tab' }
      ]);
    });
  });

  describe('mixed content', () => {
    it('splits text around enter', () => {
      expect(parseToSegments('hola enter mundo')).toEqual([
        { type: 'text', value: 'hola' },
        { type: 'key', key: 'enter' },
        { type: 'text', value: 'mundo' }
      ]);
    });

    it('handles multiple key actions', () => {
      expect(parseToSegments('tab hola tab')).toEqual([
        { type: 'key', key: 'tab' },
        { type: 'text', value: 'hola' },
        { type: 'key', key: 'tab' }
      ]);
    });

    it('handles consecutive key actions', () => {
      expect(parseToSegments('enter enter')).toEqual([
        { type: 'key', key: 'enter' },
        { type: 'key', key: 'enter' }
      ]);
    });
  });

  describe('integration with punctuation parsing', () => {
    it('parses punctuation before key actions', () => {
      expect(parseToSegments('punto enter')).toEqual([
        { type: 'text', value: '.' },
        { type: 'key', key: 'enter' }
      ]);
    });

    it('handles complex mixed content', () => {
      expect(parseToSegments('hola punto enter adios coma tab fin')).toEqual([
        { type: 'text', value: 'hola.' },
        { type: 'key', key: 'enter' },
        { type: 'text', value: 'adios,' },
        { type: 'key', key: 'tab' },
        { type: 'text', value: 'fin' }
      ]);
    });
  });

  describe('edge cases', () => {
    it('returns empty array for empty string', () => {
      expect(parseToSegments('')).toEqual([]);
    });

    it('returns text segment for no commands', () => {
      expect(parseToSegments('hello world')).toEqual([
        { type: 'text', value: 'hello world' }
      ]);
    });

    it('is case insensitive', () => {
      expect(parseToSegments('ENTER')).toEqual([
        { type: 'key', key: 'enter' }
      ]);
      expect(parseToSegments('Nueva Linea')).toEqual([
        { type: 'key', key: 'enter' }
      ]);
    });
  });
});
```
  </action>
  <verify>
```bash
cd mobile-app && npm test -- --run
```
All tests pass including new parseToSegments tests.
  </verify>
  <done>
- Test file has parseToSegments test suite
- Tests cover: enter variants, tab variants, mixed content, punctuation integration, edge cases
- All tests pass
  </done>
</task>

</tasks>

<verification>
1. `npm test -- --run` passes all tests including new parseToSegments tests
2. `npx tsc --noEmit` shows no TypeScript errors
3. `npm run build` succeeds
4. Manual check: parseToSegments('hola enter mundo') returns correct Segment array
</verification>

<success_criteria>
- parseToSegments function exported and working
- All 4 key command variants detected (nueva linea, enter, tabulador, tab)
- Punctuation parsing still works (applied before key action detection)
- API sends payload format { deviceId, payload: Segment[] }
- All existing and new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-key-actions-protocol/06-02-SUMMARY.md`
</output>
