---
phase: 01-backend-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend-server/package.json
  - backend-server/tsconfig.json
  - backend-server/src/types/messages.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript project compiles without errors"
    - "All dependencies are installed"
    - "Type definitions exist for WebSocket messages"
  artifacts:
    - path: "backend-server/package.json"
      provides: "Node.js project with Fastify and WebSocket dependencies"
      contains: "fastify"
    - path: "backend-server/tsconfig.json"
      provides: "TypeScript configuration for ESM Node.js"
      contains: "module"
    - path: "backend-server/src/types/messages.ts"
      provides: "Type definitions for WebSocket protocol"
      exports: ["ServerMessage", "AgentMessage", "QueuedMessage"]
  key_links: []
---

<objective>
Set up the backend-server TypeScript project with all dependencies and type definitions.

Purpose: Establish the foundation for all backend code - project structure, build configuration, and shared types that all other plans depend on.
Output: Compilable TypeScript project with Fastify/WebSocket dependencies and message type definitions.
</objective>

<execution_context>
@C:\Users\luish\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luish\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-backend-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend-server package and install dependencies</name>
  <files>backend-server/package.json</files>
  <action>
Create the backend-server directory and initialize a Node.js project with ESM support.

1. Create `backend-server/package.json` with:
   - name: "objetiva-speecher-backend"
   - type: "module" (ESM)
   - main: "dist/index.js"
   - scripts:
     - "dev": "tsx watch src/index.ts"
     - "build": "tsc"
     - "start": "node dist/index.js"

2. Install production dependencies:
   - fastify@^5 (HTTP server)
   - @fastify/websocket@^11 (WebSocket plugin)

3. Install dev dependencies:
   - typescript@^5
   - @types/node@^20
   - @types/ws@^8
   - tsx@^4
   - pino-pretty@^13 (optional, for dev readable logs)

Use npm for package management.
  </action>
  <verify>
Run `npm install` in backend-server directory. Should complete without errors.
Run `npm ls` to verify all dependencies are installed.
  </verify>
  <done>package.json exists with all dependencies, node_modules populated</done>
</task>

<task type="auto">
  <name>Task 2: Configure TypeScript for ESM Node.js</name>
  <files>backend-server/tsconfig.json</files>
  <action>
Create TypeScript configuration optimized for modern Node.js with ESM.

1. Create `backend-server/tsconfig.json` with:
   ```json
   {
     "compilerOptions": {
       "target": "ES2022",
       "module": "NodeNext",
       "moduleResolution": "NodeNext",
       "outDir": "dist",
       "rootDir": "src",
       "strict": true,
       "esModuleInterop": true,
       "skipLibCheck": true,
       "forceConsistentCasingInFileNames": true,
       "declaration": true,
       "resolveJsonModule": true
     },
     "include": ["src/**/*"],
     "exclude": ["node_modules", "dist"]
   }
   ```

Key settings:
- NodeNext for proper ESM resolution
- ES2022 for modern features (crypto.randomUUID)
- Strict mode for type safety
  </action>
  <verify>
Run `npx tsc --noEmit` in backend-server directory. Should complete without errors (may warn about no files, that's OK).
  </verify>
  <done>tsconfig.json exists with correct ESM configuration</done>
</task>

<task type="auto">
  <name>Task 3: Define WebSocket message types</name>
  <files>backend-server/src/types/messages.ts</files>
  <action>
Create type definitions for the WebSocket message protocol based on research recommendations.

Create `backend-server/src/types/messages.ts` with:

```typescript
// Server -> Agent messages
export type ServerMessage =
  | { type: 'transcription'; id: string; text: string; timestamp: number }

// Agent -> Server messages
export type AgentMessage =
  | { type: 'ack'; id: string }
  | { type: 'register'; deviceId: string }

// Internal: queued messages for offline agents
export interface QueuedMessage {
  id: string;
  text: string;
  timestamp: number;
}

// Connection registry entry
export interface AgentConnection {
  socket: import('ws').WebSocket;
  deviceId: string;
  connectedAt: Date;
  isAlive: boolean;
}

// Error codes per research recommendations
export type ErrorCode =
  | 'AGENT_OFFLINE'
  | 'QUEUE_FULL'
  | 'INVALID_DEVICE_ID'
  | 'INTERNAL_ERROR'
  | 'ACK_TIMEOUT'
  | 'DUPLICATE_CONNECTION';

// API response types
export interface ApiSuccessResponse {
  success: true;
  queued?: boolean;
  messageId?: string;
}

export interface ApiErrorResponse {
  success: false;
  error: {
    code: ErrorCode;
    message: string;
  };
}

export type ApiResponse = ApiSuccessResponse | ApiErrorResponse;
```

These types enforce the protocol defined in RESEARCH.md and locked in CONTEXT.md.
  </action>
  <verify>
Run `npx tsc --noEmit` in backend-server directory. Should compile without type errors.
  </verify>
  <done>Message types exported and compilable, protocol matches research spec</done>
</task>

</tasks>

<verification>
1. Directory structure exists: backend-server/src/types/
2. `npm install` runs without errors
3. `npx tsc --noEmit` compiles without errors
4. All type exports are correctly defined
</verification>

<success_criteria>
- backend-server/package.json with fastify@5, @fastify/websocket@11
- backend-server/tsconfig.json with NodeNext module resolution
- backend-server/src/types/messages.ts with all protocol types
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-01-SUMMARY.md`
</output>
