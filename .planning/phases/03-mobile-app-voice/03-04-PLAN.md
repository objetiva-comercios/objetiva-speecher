---
phase: 03-mobile-app-voice
plan: 04
type: execute
wave: 2
depends_on: ["03-02", "03-03"]
files_modified:
  - mobile-app/src/hooks/useDeviceList.ts
  - mobile-app/src/hooks/useNetworkStatus.ts
  - mobile-app/src/components/DeviceSelector.tsx
  - mobile-app/src/components/StatusIndicator.tsx
  - mobile-app/src/components/OfflineBanner.tsx
autonomous: true

must_haves:
  truths:
    - "User sees dropdown with connected devices"
    - "Each device shows hostname and status dot (green/gray)"
    - "Last used device is auto-selected on app open"
    - "Empty state shown when no devices connected"
    - "Offline banner appears when network is down"
    - "Status indicator shows connection state near device selector"
  artifacts:
    - path: "mobile-app/src/components/DeviceSelector.tsx"
      provides: "Device dropdown with status dots"
      min_lines: 40
    - path: "mobile-app/src/hooks/useDeviceList.ts"
      provides: "Device polling and last-used persistence"
      exports: ["useDeviceList"]
    - path: "mobile-app/src/components/OfflineBanner.tsx"
      provides: "Offline state banner"
      min_lines: 10
  key_links:
    - from: "mobile-app/src/hooks/useDeviceList.ts"
      to: "mobile-app/src/services/api.ts"
      via: "getApiClient().getDevices()"
      pattern: "getDevices"
    - from: "mobile-app/src/components/DeviceSelector.tsx"
      to: "mobile-app/src/hooks/useDeviceList.ts"
      via: "useDeviceList()"
      pattern: "useDeviceList"
---

<objective>
Create device selection UI components and hooks for displaying connected devices, status indicators, and offline state.

Purpose: Enable user to see and select target PC from list of connected devices with visual status feedback.
Output: DeviceSelector, StatusIndicator, OfflineBanner components with supporting hooks.
</objective>

<execution_context>
@C:\Users\luish\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luish\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-mobile-app-voice/03-CONTEXT.md
@.planning/phases/03-mobile-app-voice/03-RESEARCH.md
@mobile-app/src/types/index.ts
@mobile-app/src/services/api.ts
@mobile-app/src/services/network.ts
@mobile-app/src/services/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create network status and device list hooks</name>
  <files>
    mobile-app/src/hooks/useNetworkStatus.ts
    mobile-app/src/hooks/useDeviceList.ts
  </files>
  <action>
    Create hooks directory and implement useNetworkStatus and useDeviceList hooks.

    1. Create src/hooks/useNetworkStatus.ts:
    ```typescript
    import { useState, useEffect } from 'react';
    import type { ConnectionStatus } from '../types';
    import {
      checkNetworkStatus,
      subscribeToNetworkStatus,
      startNetworkMonitoring,
      stopNetworkMonitoring,
      setReconnecting,
    } from '../services/network';

    interface UseNetworkStatusResult {
      status: ConnectionStatus;
      isOnline: boolean;
      isReconnecting: boolean;
    }

    /**
     * Hook for monitoring network connectivity status.
     * Per user decision: show offline banner and "Reconnecting..." state.
     */
    export function useNetworkStatus(
      onOnline?: () => void,
      onOffline?: () => void
    ): UseNetworkStatusResult {
      const [status, setStatus] = useState<ConnectionStatus>('online');

      useEffect(() => {
        // Check initial status
        checkNetworkStatus().then(online => {
          setStatus(online ? 'online' : 'offline');
        });

        // Subscribe to status changes
        const unsubscribe = subscribeToNetworkStatus(setStatus);

        // Start monitoring with callbacks
        startNetworkMonitoring(
          () => {
            // Mark as reconnecting, then call onOnline
            setReconnecting(true);
            onOnline?.();
          },
          () => {
            onOffline?.();
          }
        );

        return () => {
          unsubscribe();
          stopNetworkMonitoring();
        };
      }, [onOnline, onOffline]);

      return {
        status,
        isOnline: status === 'online',
        isReconnecting: status === 'reconnecting',
      };
    }
    ```

    2. Create src/hooks/useDeviceList.ts:
    ```typescript
    import { useState, useEffect, useCallback } from 'react';
    import type { Device } from '../types';
    import { getApiClient, isApiClientInitialized } from '../services/api';
    import { getItem, setItem, STORAGE_KEYS } from '../services/storage';

    const POLL_INTERVAL_MS = 5000;  // Poll every 5 seconds per research

    interface UseDeviceListResult {
      devices: Device[];
      selectedDevice: string | null;
      selectDevice: (hostname: string) => void;
      isLoading: boolean;
      error: string | null;
      hasDevices: boolean;
      refresh: () => Promise<void>;
    }

    /**
     * Hook for managing device list with polling and last-used persistence.
     * Per user decision:
     * - Dropdown selector always visible
     * - Auto-select last used device on app open
     * - Show hostname + status dot per device
     * - When no devices connected: empty state
     */
    export function useDeviceList(): UseDeviceListResult {
      const [devices, setDevices] = useState<Device[]>([]);
      const [selectedDevice, setSelectedDevice] = useState<string | null>(null);
      const [isLoading, setIsLoading] = useState(true);
      const [error, setError] = useState<string | null>(null);

      // Fetch devices from backend
      const fetchDevices = useCallback(async () => {
        if (!isApiClientInitialized()) {
          setError('Backend no configurado');
          setIsLoading(false);
          return;
        }

        try {
          const api = getApiClient();
          const hostnames = await api.getDevices();

          // All fetched devices are online (only connected devices returned)
          const deviceList: Device[] = hostnames.map(hostname => ({
            hostname,
            isOnline: true,
          }));

          setDevices(deviceList);
          setError(null);

          // If selected device is no longer in list, clear selection
          if (selectedDevice && !hostnames.includes(selectedDevice)) {
            // Keep the selection but mark as offline visually
            // User can still send - it will queue
          }
        } catch (err) {
          setError('Error al obtener dispositivos');
          console.error('Failed to fetch devices:', err);
        } finally {
          setIsLoading(false);
        }
      }, [selectedDevice]);

      // Load last used device from storage
      const loadLastDevice = useCallback(async () => {
        const lastDevice = await getItem(STORAGE_KEYS.LAST_DEVICE);
        if (lastDevice) {
          setSelectedDevice(lastDevice);
        }
      }, []);

      // Select a device and persist
      const selectDevice = useCallback(async (hostname: string) => {
        setSelectedDevice(hostname);
        await setItem(STORAGE_KEYS.LAST_DEVICE, hostname);
      }, []);

      // Initial load
      useEffect(() => {
        loadLastDevice();
        fetchDevices();
      }, [loadLastDevice, fetchDevices]);

      // Poll for updates
      useEffect(() => {
        const interval = setInterval(fetchDevices, POLL_INTERVAL_MS);
        return () => clearInterval(interval);
      }, [fetchDevices]);

      // Auto-select first device if none selected and devices available
      useEffect(() => {
        if (!selectedDevice && devices.length > 0) {
          selectDevice(devices[0].hostname);
        }
      }, [devices, selectedDevice, selectDevice]);

      return {
        devices,
        selectedDevice,
        selectDevice,
        isLoading,
        error,
        hasDevices: devices.length > 0,
        refresh: fetchDevices,
      };
    }
    ```
  </action>
  <verify>
    Files exist: `ls mobile-app/src/hooks/`
    useNetworkStatus exports: grep for "export function useNetworkStatus"
    useDeviceList has polling: grep for "POLL_INTERVAL"
  </verify>
  <done>
    useNetworkStatus hook monitors online/offline/reconnecting states.
    useDeviceList hook polls every 5 seconds, persists last-used device.
    Auto-selects first device if none selected.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DeviceSelector and StatusIndicator components</name>
  <files>
    mobile-app/src/components/DeviceSelector.tsx
    mobile-app/src/components/StatusIndicator.tsx
  </files>
  <action>
    Create components directory and implement DeviceSelector and StatusIndicator.

    1. Create src/components/StatusIndicator.tsx:
    ```tsx
    import type { ConnectionStatus } from '../types';

    interface StatusIndicatorProps {
      status: ConnectionStatus;
    }

    /**
     * Connection status indicator.
     * Per user decision: near device selector (not header bar).
     * Shows online (green), offline (red), or reconnecting (yellow pulse).
     */
    export function StatusIndicator({ status }: StatusIndicatorProps) {
      const statusConfig = {
        online: {
          color: 'bg-green-500',
          label: 'Conectado',
          pulse: false,
        },
        offline: {
          color: 'bg-red-500',
          label: 'Sin conexion',
          pulse: false,
        },
        reconnecting: {
          color: 'bg-yellow-500',
          label: 'Reconectando...',
          pulse: true,
        },
      };

      const config = statusConfig[status];

      return (
        <div className="flex items-center gap-2">
          <span
            className={`w-3 h-3 rounded-full ${config.color} ${
              config.pulse ? 'animate-pulse' : ''
            }`}
          />
          <span className="text-sm text-gray-600">{config.label}</span>
        </div>
      );
    }
    ```

    2. Create src/components/DeviceSelector.tsx:
    ```tsx
    import type { Device } from '../types';

    interface DeviceSelectorProps {
      devices: Device[];
      selectedDevice: string | null;
      onSelect: (hostname: string) => void;
      isLoading: boolean;
      disabled?: boolean;
    }

    /**
     * Device dropdown selector.
     * Per user decision:
     * - Dropdown selector always visible on main screen
     * - Show hostname + status dot (green/gray) per device
     * - When no devices connected: empty state message, disable recording
     */
    export function DeviceSelector({
      devices,
      selectedDevice,
      onSelect,
      isLoading,
      disabled = false,
    }: DeviceSelectorProps) {
      // Empty state when no devices
      if (!isLoading && devices.length === 0) {
        return (
          <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
            <p className="text-gray-500 text-center">
              No hay dispositivos conectados
            </p>
            <p className="text-gray-400 text-sm text-center mt-1">
              Inicia el agente en tu PC
            </p>
          </div>
        );
      }

      if (isLoading) {
        return (
          <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
            <p className="text-gray-400 text-center">Buscando dispositivos...</p>
          </div>
        );
      }

      return (
        <div className="relative">
          <select
            value={selectedDevice || ''}
            onChange={(e) => onSelect(e.target.value)}
            disabled={disabled}
            className={`
              w-full p-3 pr-10 rounded-lg border border-gray-300
              bg-white text-gray-800
              focus:ring-2 focus:ring-blue-500 focus:border-blue-500
              disabled:bg-gray-100 disabled:text-gray-400
              appearance-none cursor-pointer
            `}
          >
            {devices.map((device) => (
              <option key={device.hostname} value={device.hostname}>
                {device.isOnline ? 'ðŸŸ¢' : 'âšª'} {device.hostname}
              </option>
            ))}
          </select>
          {/* Dropdown arrow */}
          <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
            <svg
              className="w-5 h-5 text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M19 9l-7 7-7-7"
              />
            </svg>
          </div>
        </div>
      );
    }
    ```
  </action>
  <verify>
    Files exist: `ls mobile-app/src/components/`
    DeviceSelector has empty state: grep for "No hay dispositivos"
    StatusIndicator has reconnecting: grep for "Reconectando"
  </verify>
  <done>
    DeviceSelector shows dropdown with hostname + status dots.
    Empty state message when no devices connected.
    StatusIndicator shows online/offline/reconnecting with visual feedback.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create OfflineBanner component</name>
  <files>
    mobile-app/src/components/OfflineBanner.tsx
  </files>
  <action>
    Create OfflineBanner component for offline state display.
    Per user decision: offline state shows banner + disabled recording button.

    ```tsx
    import type { ConnectionStatus } from '../types';

    interface OfflineBannerProps {
      status: ConnectionStatus;
    }

    /**
     * Offline/reconnecting banner.
     * Per user decision:
     * - Offline state: banner + disabled recording button
     * - Show "Reconnecting..." state during connection recovery
     */
    export function OfflineBanner({ status }: OfflineBannerProps) {
      if (status === 'online') {
        return null;
      }

      const config = {
        offline: {
          bg: 'bg-red-50',
          border: 'border-red-200',
          text: 'text-red-700',
          message: 'Sin conexion a internet',
          submessage: 'Las transcripciones se guardaran en cola',
        },
        reconnecting: {
          bg: 'bg-yellow-50',
          border: 'border-yellow-200',
          text: 'text-yellow-700',
          message: 'Reconectando...',
          submessage: 'Intentando restablecer conexion',
        },
      };

      const { bg, border, text, message, submessage } = config[status];

      return (
        <div className={`${bg} ${border} border rounded-lg p-3 mb-4`}>
          <p className={`${text} font-medium`}>{message}</p>
          <p className={`${text} text-sm opacity-75`}>{submessage}</p>
        </div>
      );
    }
    ```
  </action>
  <verify>
    File exists: `cat mobile-app/src/components/OfflineBanner.tsx`
    Shows offline message: grep for "Sin conexion"
    Shows reconnecting message: grep for "Reconectando"
  </verify>
  <done>
    OfflineBanner shows appropriate message for offline/reconnecting states.
    Hidden when online.
    Informs user that transcriptions will queue when offline.
  </done>
</task>

</tasks>

<verification>
1. `ls mobile-app/src/hooks/` shows useDeviceList.ts and useNetworkStatus.ts
2. `ls mobile-app/src/components/` shows DeviceSelector.tsx, StatusIndicator.tsx, OfflineBanner.tsx
3. `cd mobile-app && npx tsc --noEmit` passes
</verification>

<success_criteria>
- useDeviceList polls every 5 seconds and persists last-used device
- useNetworkStatus tracks online/offline/reconnecting states
- DeviceSelector shows dropdown with status dots per device
- DeviceSelector shows empty state when no devices connected
- StatusIndicator shows visual connection status
- OfflineBanner appears for offline/reconnecting states
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-mobile-app-voice/03-04-SUMMARY.md`
</output>
