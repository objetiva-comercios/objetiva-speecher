---
phase: 02-windows-desktop-agent
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - windows-agent/src/paste/clipboard.ts
  - windows-agent/src/paste/keyboard.ts
  - windows-agent/src/paste/paste.ts
autonomous: true

must_haves:
  truths:
    - "Text can be written to system clipboard"
    - "Ctrl+V keystroke can be simulated"
    - "Clipboard content is verified before paste"
    - "Paste failures result in clipboard-only fallback"
  artifacts:
    - path: "windows-agent/src/paste/clipboard.ts"
      provides: "Clipboard write with verification"
      contains: "clipboard.write"
    - path: "windows-agent/src/paste/keyboard.ts"
      provides: "Ctrl+V simulation with try-finally for key release"
      contains: "LeftControl.*V"
    - path: "windows-agent/src/paste/paste.ts"
      provides: "Orchestrated paste flow with fallback"
      contains: "pasteText"
  key_links:
    - from: "windows-agent/src/paste/paste.ts"
      to: "windows-agent/src/paste/clipboard.ts"
      via: "imports writeClipboard"
      pattern: "import.*clipboard"
    - from: "windows-agent/src/paste/paste.ts"
      to: "windows-agent/src/paste/keyboard.ts"
      via: "imports simulatePaste"
      pattern: "import.*keyboard"
---

<objective>
Implement the paste flow: clipboard operations, keyboard simulation, and orchestration with fallback.

Purpose: Enable auto-paste of received text at cursor position, with graceful fallback to clipboard-only if paste fails.
Output: Paste module that writes to clipboard, verifies, and simulates Ctrl+V
</objective>

<execution_context>
@C:\Users\luish\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luish\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-windows-desktop-agent/02-RESEARCH.md
@windows-agent/src/types.ts
@windows-agent/src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement clipboard operations with verification</name>
  <files>windows-agent/src/paste/clipboard.ts</files>
  <action>
Create windows-agent/src/paste/clipboard.ts with clipboard write and verification:

```typescript
import clipboard from 'clipboardy';
import { config } from '../config.js';

/**
 * Write text to clipboard with verification (WIN-04, WIN-07, WIN-08)
 * Retries once if verification fails
 * @returns true if verified, false if clipboard-only fallback needed
 */
export async function writeClipboard(text: string): Promise<boolean> {
  for (let attempt = 0; attempt <= config.CLIPBOARD_VERIFY_RETRIES; attempt++) {
    await clipboard.write(text);

    // Verify clipboard content
    const content = await clipboard.read();
    if (content === text) {
      return true; // Verified successfully
    }
    // Will retry on next iteration
  }

  // All retries exhausted - text is in clipboard but not verified
  return false;
}

/**
 * Read current clipboard content (for debugging/logging)
 */
export async function readClipboard(): Promise<string> {
  return clipboard.read();
}
```

ESM import note: Use `.js` extension in imports even though source is `.ts` (NodeNext requirement).
  </action>
  <verify>npx tsc --noEmit passes, clipboard.ts exports writeClipboard and readClipboard</verify>
  <done>writeClipboard writes text, verifies content matches, retries once on failure</done>
</task>

<task type="auto">
  <name>Task 2: Implement keyboard simulation with modifier safety</name>
  <files>windows-agent/src/paste/keyboard.ts</files>
  <action>
Create windows-agent/src/paste/keyboard.ts with Ctrl+V simulation:

```typescript
import { keyboard, Key } from '@nut-tree/nut-js';

/**
 * Simulate Ctrl+V keystroke (WIN-05)
 * Uses try-finally to ensure modifier keys are always released (Pitfall #1)
 * @throws Error if keyboard simulation fails
 */
export async function simulatePaste(): Promise<void> {
  try {
    await keyboard.pressKey(Key.LeftControl, Key.V);
  } finally {
    // CRITICAL: Always release to prevent stuck modifier keys
    await keyboard.releaseKey(Key.LeftControl, Key.V);
  }
}
```

The try-finally pattern ensures LeftControl is released even if V press fails.
This prevents the "Ctrl key stuck" issue documented in research pitfalls.
  </action>
  <verify>npx tsc --noEmit passes, keyboard.ts exports simulatePaste</verify>
  <done>simulatePaste simulates Ctrl+V with guaranteed key release via try-finally</done>
</task>

<task type="auto">
  <name>Task 3: Implement paste orchestration with fallback</name>
  <files>windows-agent/src/paste/paste.ts</files>
  <action>
Create windows-agent/src/paste/paste.ts that orchestrates the full paste flow:

```typescript
import { writeClipboard } from './clipboard.js';
import { simulatePaste } from './keyboard.js';
import { config } from '../config.js';
import type { PasteResult } from '../types.js';

/**
 * Delay helper
 */
function delay(ms: number): Promise<void> {
  return new Promise(resolve => setTimeout(resolve, ms));
}

/**
 * Full paste flow: clipboard write -> verify -> delay -> Ctrl+V
 * Falls back to clipboard-only if paste simulation fails (DEL-04)
 *
 * @param text - Text to paste
 * @returns PasteResult with success status and method used
 */
export async function pasteText(text: string): Promise<PasteResult> {
  // Step 1: Write to clipboard with verification (WIN-04, WIN-07, WIN-08)
  const verified = await writeClipboard(text);

  if (!verified) {
    // Clipboard write or verification failed
    // Text may or may not be in clipboard - fallback mode
    return {
      success: false,
      method: 'clipboard-only',
      error: 'Clipboard verification failed after retries',
    };
  }

  // Step 2: Delay before paste (WIN-06)
  await delay(config.PASTE_DELAY_MS);

  // Step 3: Simulate Ctrl+V (WIN-05)
  try {
    await simulatePaste();
    return {
      success: true,
      method: 'paste',
    };
  } catch (error) {
    // DEL-04: Paste simulation failed, text remains in clipboard
    return {
      success: false,
      method: 'clipboard-only',
      error: error instanceof Error ? error.message : 'Paste simulation failed',
    };
  }
}
```

This implements the full flow from research:
1. Write clipboard with verification and retry
2. Apply 75ms delay (configurable)
3. Simulate Ctrl+V with try-finally safety
4. Fall back to clipboard-only on any failure
  </action>
  <verify>npx tsc --noEmit passes, paste.ts exports pasteText returning PasteResult</verify>
  <done>pasteText orchestrates clipboard write -> verify -> delay -> Ctrl+V with fallback on failure</done>
</task>

</tasks>

<verification>
1. `cd windows-agent && npx tsc --noEmit` exits 0
2. clipboard.ts: writeClipboard writes and verifies, retries once
3. keyboard.ts: simulatePaste uses try-finally for key release safety
4. paste.ts: pasteText implements full flow with 75ms delay and fallback
5. All imports use `.js` extension for ESM compatibility
</verification>

<success_criteria>
- Clipboard write with verification and retry (WIN-04, WIN-07, WIN-08)
- Ctrl+V simulation with guaranteed key release (WIN-05, Pitfall #1)
- 75ms delay between clipboard and paste (WIN-06)
- Graceful fallback to clipboard-only on any failure (DEL-04)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-windows-desktop-agent/02-02-SUMMARY.md`
</output>
