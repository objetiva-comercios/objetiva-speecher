---
phase: 02-windows-desktop-agent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - windows-agent/package.json
  - windows-agent/tsconfig.json
  - windows-agent/src/types.ts
  - windows-agent/src/config.ts
autonomous: true

must_haves:
  truths:
    - "Agent project compiles with TypeScript"
    - "All dependencies for clipboard, keyboard, WebSocket are installed"
  artifacts:
    - path: "windows-agent/package.json"
      provides: "ESM project with clipboardy, nut.js, ws, pino"
      contains: "type.*module"
    - path: "windows-agent/tsconfig.json"
      provides: "TypeScript NodeNext config matching backend"
      contains: "NodeNext"
    - path: "windows-agent/src/types.ts"
      provides: "Message types matching backend protocol"
      contains: "ServerMessage"
    - path: "windows-agent/src/config.ts"
      provides: "Agent configuration with sensible defaults"
      contains: "BACKEND_URL"
  key_links:
    - from: "windows-agent/src/types.ts"
      to: "backend-server/src/types/messages.ts"
      via: "Same message protocol definitions"
      pattern: "type.*transcription.*id.*text"
---

<objective>
Scaffold the Windows desktop agent project with TypeScript configuration and core dependencies.

Purpose: Establish the foundation for the agent with matching patterns from backend. Types must align with backend message protocol.
Output: Compilable TypeScript project with clipboardy, nut.js, ws, and pino installed
</objective>

<execution_context>
@C:\Users\luish\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luish\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-windows-desktop-agent/02-RESEARCH.md
@backend-server/src/types/messages.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create windows-agent package with dependencies</name>
  <files>windows-agent/package.json</files>
  <action>
Create the windows-agent directory and initialize ESM Node.js project with:

Production dependencies:
- clipboardy@5.2.1 - clipboard read/write
- @nut-tree/nut-js@4 - keyboard automation (Ctrl+V)
- ws@8 - WebSocket client (same as backend)
- pino@9 - structured logging (match backend)

Dev dependencies:
- typescript@5
- @types/node@22
- @types/ws@8
- tsx@4 - TypeScript execution for dev
- pino-pretty@13 - dev-friendly logs

Package settings:
- "type": "module" for ESM
- "main": "dist/index.js"
- scripts: "dev": "tsx --watch src/index.ts | pino-pretty", "build": "tsc", "start": "node dist/index.js"

Run npm install after creating package.json.
  </action>
  <verify>npm ls in windows-agent shows clipboardy, @nut-tree/nut-js, ws, pino installed</verify>
  <done>package.json exists with ESM config, all dependencies installed, node_modules populated</done>
</task>

<task type="auto">
  <name>Task 2: Configure TypeScript for ESM Node.js</name>
  <files>windows-agent/tsconfig.json</files>
  <action>
Create TypeScript configuration matching backend patterns:

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "outDir": "dist",
    "rootDir": "src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "declaration": true,
    "resolveJsonModule": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

Create empty src/ directory.
Run `npx tsc --noEmit` to verify config is valid (will pass since no source files yet).
  </action>
  <verify>npx tsc --noEmit in windows-agent exits with code 0</verify>
  <done>tsconfig.json exists with NodeNext resolution, src/ directory created</done>
</task>

<task type="auto">
  <name>Task 3: Define agent types and configuration</name>
  <files>windows-agent/src/types.ts, windows-agent/src/config.ts</files>
  <action>
Create types.ts with message types matching backend protocol:

```typescript
// Messages from backend (receive)
export type ServerMessage = {
  type: 'transcription';
  id: string;
  text: string;
  timestamp: number;
};

// Messages to backend (send)
export type AgentMessage =
  | { type: 'register'; deviceId: string }
  | { type: 'ack'; id: string };

// Paste operation result
export interface PasteResult {
  success: boolean;
  method: 'paste' | 'clipboard-only';
  error?: string;
}

// Agent connection state
export type ConnectionState = 'disconnected' | 'connecting' | 'connected' | 'registered';
```

Create config.ts with configuration:

```typescript
export const config = {
  // Backend connection
  BACKEND_URL: process.env.SPEECHER_BACKEND_URL || 'ws://localhost:3000/ws',

  // Reconnection (RES-04)
  RECONNECT_MIN_DELAY: 1000,      // 1s initial
  RECONNECT_MAX_DELAY: 30000,     // 30s max
  RECONNECT_FACTOR: 2,            // Exponential factor
  RECONNECT_JITTER: 0.15,         // 10-20% jitter

  // Heartbeat (RES-05, RES-06)
  HEARTBEAT_TIMEOUT: 35000,       // 35s - allow some slack on 30s server ping

  // Paste timing (WIN-06)
  PASTE_DELAY_MS: 75,             // 75ms per research recommendation

  // Clipboard verification (WIN-07, WIN-08)
  CLIPBOARD_VERIFY_RETRIES: 1,    // Retry once on verification failure
} as const;

export type Config = typeof config;
```

Run `npx tsc --noEmit` to verify types compile.
  </action>
  <verify>npx tsc --noEmit in windows-agent exits with code 0, types.ts and config.ts exist in src/</verify>
  <done>Type definitions match backend protocol, config has all required timing constants per research</done>
</task>

</tasks>

<verification>
1. `cd windows-agent && npm ls` shows all dependencies installed
2. `cd windows-agent && npx tsc --noEmit` exits 0 (TypeScript compiles)
3. types.ts contains ServerMessage, AgentMessage matching backend
4. config.ts has BACKEND_URL, reconnection params, paste timing constants
</verification>

<success_criteria>
- windows-agent/package.json with "type": "module" and all deps
- TypeScript compiles with NodeNext resolution
- Types mirror backend message protocol (transcription, ack, register)
- Config has all timing constants from research (reconnect 1s-30s, heartbeat 35s, paste 75ms)
</success_criteria>

<output>
After completion, create `.planning/phases/02-windows-desktop-agent/02-01-SUMMARY.md`
</output>
