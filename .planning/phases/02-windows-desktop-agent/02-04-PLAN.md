---
phase: 02-windows-desktop-agent
plan: 04
type: execute
wave: 4
depends_on: ["02-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Agent connects and appears in /devices"
    - "Text sent to /transcription appears at cursor position"
    - "Agent reconnects after backend restart"
    - "Paste failure leaves text in clipboard for manual paste"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete Windows agent flow end-to-end with the backend.

Purpose: Confirm all success criteria are met before moving to Phase 3.
Output: Verified working agent ready for production use
</objective>

<execution_context>
@C:\Users\luish\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\luish\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-windows-desktop-agent/02-RESEARCH.md
@windows-agent/package.json
@backend-server/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start backend and verify agent connection</name>
  <files></files>
  <action>
Start the backend server and agent, verify connection:

1. In terminal 1 (backend):
   ```bash
   cd backend-server
   npm run dev
   ```
   Wait for "Server listening on port 3000"

2. In terminal 2 (agent):
   ```bash
   cd windows-agent
   npm run dev
   ```
   Watch for:
   - "Connecting to backend"
   - "WebSocket connected, registering..."
   - "Registered with backend"

3. Verify registration via API:
   ```bash
   curl http://localhost:3000/devices
   ```
   Should return JSON array containing the hostname

4. Test transcription delivery:
   - Open a text editor (Notepad, VS Code, etc.)
   - Click to place cursor
   - Send transcription:
   ```bash
   curl -X POST http://localhost:3000/transcription \
     -H "Content-Type: application/json" \
     -d '{"deviceId": "<HOSTNAME>", "text": "Hola mundo desde Speecher"}'
   ```
   Replace <HOSTNAME> with the hostname shown in /devices response.

5. Verify:
   - Text "Hola mundo desde Speecher" appears in the text editor
   - Agent logs show "Paste succeeded" with method: "paste"
   - curl response shows success: true

Note: HOSTNAME is case-insensitive (backend normalizes to lowercase).
  </action>
  <verify>curl /devices shows agent, curl /transcription succeeds, text appears in text editor</verify>
  <done>Agent connects, registers, receives transcription, pastes text at cursor</done>
</task>

<task type="auto">
  <name>Task 2: Verify reconnection and resilience</name>
  <files></files>
  <action>
Test reconnection behavior:

1. With agent running and connected, stop the backend (Ctrl+C in terminal 1)

2. Watch agent logs:
   - Should show "Connection closed" with code
   - Should show "Scheduling reconnection" with delay
   - Delays should increase: ~1s, ~2s, ~4s, ~8s...

3. Restart backend:
   ```bash
   cd backend-server
   npm run dev
   ```

4. Watch agent logs:
   - Should show "Connecting to backend" on next retry
   - Should show "Registered with backend" once reconnected

5. Verify with API:
   ```bash
   curl http://localhost:3000/devices
   ```
   Should show the agent again

6. Send another transcription to confirm full recovery:
   - Place cursor in text editor
   ```bash
   curl -X POST http://localhost:3000/transcription \
     -H "Content-Type: application/json" \
     -d '{"deviceId": "<HOSTNAME>", "text": "Reconexion exitosa"}'
   ```
   Should paste "Reconexion exitosa"

This verifies:
- RES-04: Exponential backoff reconnection
- RES-05/RES-06: Heartbeat handled (implicit - connection stays alive)
  </action>
  <verify>Agent reconnects after backend restart, continues receiving transcriptions</verify>
  <done>Exponential backoff works, agent recovers from network interruption</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Windows desktop agent with WebSocket connection, auto-paste, and resilience</what-built>
  <how-to-verify>
1. Start backend: `cd backend-server && npm run dev`
2. Start agent: `cd windows-agent && npm run dev`
3. Verify agent appears: `curl http://localhost:3000/devices`
4. Open any text editor (Notepad, VS Code, Word, etc.)
5. Click to place cursor where you want text
6. Send transcription:
   ```
   curl -X POST http://localhost:3000/transcription -H "Content-Type: application/json" -d "{\"deviceId\": \"YOUR_HOSTNAME\", \"text\": \"Test from Speecher - funciona!\"}"
   ```
7. Verify text appears at cursor position
8. Test fallback: Focus an admin application (if available) and repeat - text should be in clipboard even if paste fails

Expected:
- Text pastes automatically in most applications
- Agent logs show success/failure status
- If paste fails, Ctrl+V manually pastes from clipboard

Test reconnection:
9. Stop backend (Ctrl+C), watch agent show reconnection attempts with increasing delays
10. Restart backend, confirm agent reconnects and can receive transcriptions again
  </how-to-verify>
  <resume-signal>Type "approved" if all success criteria pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 2 Success Criteria verification:
1. [x] Agent connects to backend with hostname-based deviceId and appears in /devices
2. [x] Text received via WebSocket appears at cursor position in any focused application
3. [x] Agent reconnects automatically after network interruption (with exponential backoff)
4. [x] Agent responds to heartbeat pings and detects connection loss via missed pongs
5. [x] If paste simulation fails, text remains in clipboard for manual paste
</verification>

<success_criteria>
All Phase 2 success criteria verified by human tester:
- Agent shows in /devices with hostname
- Transcription auto-pastes at cursor
- Reconnection with exponential backoff works
- Clipboard fallback works when paste fails
</success_criteria>

<output>
After completion, create `.planning/phases/02-windows-desktop-agent/02-04-SUMMARY.md`
</output>
